// importador-massivo-v11-final.js
// V11: SeparaÃ§Ã£o Real de Conjuntos (Shorts vs CalÃ§as) com ID novo

const { createClient } = require('@sanity/client');
const puppeteer = require('puppeteer-extra');
const StealthPlugin = require('puppeteer-extra-plugin-stealth');
const axios = require('axios');
const slugify = require('slugify');
const fs = require('fs');
puppeteer.use(StealthPlugin());

// --- CONFIGURAÃ‡ÃƒO SANITY ---
const client = createClient({
  projectId: 'o4upb251',
  dataset: 'production',
  apiVersion: '2023-05-03',
  useCdn: false,
  token: 'skmLtdy7ME2lnyS0blM3IWiNv0wuWzBG4egK7jUYdVVkBktLngwz47GbsPPdq5NLX58WJEiR3bmW0TBpeMtBhPNEIxf5mk6uQ14PvbGYKlWQdSiP2uWdBDafWhVAGMw5RYh3IyKhDSmqEqSLg1bEzzYVEwcGWDZ9tEPmZhNDkljeyvY6IcEO' 
});
const generateKey = () => Math.random().toString(36).substring(2, 15);

// --- MAPA DE CATEGORIAS (IDs Separados) ---
const CATEGORY_MAP = [
    // === PRIORIDADE 1: CONJUNTOS (VerificaÃ§Ã£o no Link e Texto) ===
    
    // 1.1 Conjuntos SAIAS
    {
        id: '2c2a840e-6a86-47e1-9276-3a3993946c26',
        rules: [
            /CONJUNTO.*SAIA/i,      
            /CJ.*SAIA/i,            
            /SAIA.*CROPPED/i,       
            /SAIA.*BLUSA/i,
            /SAIA.*TOP/i
        ]
    },

    // 1.2 Conjuntos SHORTS (ID NOVO QUE VOCÃŠ ENVIOU AGORA)
    {
        id: 'c2bdb8f1-5783-4019-a806-f1265b501998', 
        rules: [
            /CONJUNTO.*SHORT/i,     
            /CJ.*SHORT/i,
            /SHORT.*CROPPED/i,
            /SHORT.*BLUSA/i,
            /SHORT.*TOP/i,
            /SHORT.*CAMISA/i,
            /CONJUNTO.*BERMUDA/i
        ]
    },

    // 1.3 Conjuntos CALÃ‡AS (ID ANTIGO - Fica exclusivo para calÃ§as)
    {
        id: '25aa9265-d05b-4fc0-be64-8f41a20b780a',
        rules: [
            /CONJUNTO.*CAL(Ã‡|C)A/i, 
            /CJ.*CAL(Ã‡|C)A/i,
            /CONJUNTO.*PANTALONA/i,
            /CAL(Ã‡|C)A.*CROPPED/i,
            /CAL(Ã‡|C)A.*BLUSA/i,
            /CAL(Ã‡|C)A.*TOP/i
        ]
    },

    // === PRIORIDADE 2: PEÃ‡AS ÃšNICAS ===
    { id: '0b360a5f-6923-4c22-8d16-6d3ba65f98a2', rules: ['CALÃ‡ADO', 'SAPATO', 'TÃŠNIS', 'SANDÃLIA', 'BOTA', 'PAPETE', 'MULE', 'RASTEIRA'] },
    { id: '1dcd7f06-7dd8-49af-be15-7b19d6d5f15c', rules: ['BERMUDA', 'SHORT'] }, 
    { id: '26077718-39db-4055-b32a-bc91b4be36d4', rules: ['CAMISA', 'CAMISETE'] },
    { id: '2a346772-2540-4da4-b29a-35d8155d8d90', rules: ['SAIA'] },
    { id: '0b5f498b-3f74-4818-9f16-604b11e26f05', rules: ['CALÃ‡A', 'JEANS', 'PANTALONA', 'LEGGING', 'CALCA'] },
    { id: 'dc0d33a3-9165-4d57-8cc2-830f9311d26b', rules: ['VESTIDO', 'LONGO', 'MIDI', 'CURTO'] },
    { id: '7ef4bb1b-a674-41cc-b38e-dd3daa2f19ac', rules: ['BLUSA', 'TOP', 'CROPPED', 'REGATA', 'BODY', 'T-SHIRT', 'TRICOT'] },
    { id: '9ca0fcfe-9f06-44db-8c84-f8d395b610ea', rules: ['MACACÃƒO', 'MACAQUINHO', 'JARDINEIRA'] }
];

const DEFAULT_CATEGORY_ID = '7ef4bb1b-a674-41cc-b38e-dd3daa2f19ac'; // PadrÃ£o: Blusas

// --- FUNÃ‡ÃƒO DE MAPEAMENTO INTELIGENTE (Com URL) ---
function getFixedCategoryId(detectedName, productTitle, productDescription, productUrl) {
    const cleanUrl = productUrl ? productUrl.replace(/-/g, ' ').replace(/\//g, ' ') : '';
    const textToScan = (detectedName + ' ' + productTitle + ' ' + (productDescription || '') + ' ' + cleanUrl).toUpperCase();
    
    for (const category of CATEGORY_MAP) {
        for (const rule of category.rules) {
            if (rule instanceof RegExp) {
                if (rule.test(textToScan)) return category.id;
            } 
            else if (typeof rule === 'string') {
                if (textToScan.includes(rule)) return category.id;
            }
        }
    }
    return DEFAULT_CATEGORY_ID;
}

// --- UPLOAD ---
async function uploadMediaToSanity(mediaUrl) {
  if (!mediaUrl) return null;
  try {
    const response = await axios.get(mediaUrl, { responseType: 'arraybuffer', timeout: 30000, headers: { 'User-Agent': 'Mozilla/5.0' } });
    const buffer = Buffer.from(response.data, 'binary');
    const asset = await client.assets.upload('image', buffer, { filename: mediaUrl.split('/').pop() });
    return { _type: 'image', asset: { _type: 'reference', _ref: asset._id }, _key: generateKey() };
  } catch (error) { return null; }
}

async function processSingleProduct(page, url) {
    console.log(`\nğŸ”— Acessando: ${url}`);
    await page.goto(url, { waitUntil: 'domcontentloaded', timeout: 60000 });

    const mainData = await page.evaluate(() => {
        const title = document.querySelector('.product-name h1')?.innerText.trim() || 'Produto Sem TÃ­tulo';
        
        // --- CORREÃ‡ÃƒO DE PREÃ‡O ---
        let priceElement = document.querySelector('.special-price .price');
        if (!priceElement) priceElement = document.querySelector('.regular-price .price');
        if (!priceElement) priceElement = document.querySelector('.price-box .price:not(.old-price .price)');

        let priceText = priceElement ? priceElement.innerText.trim() : '0';
        let rawPrice = parseFloat(
            priceText.replace(/[^\d,.]/g, '').replace(/\./g, '').replace(',', '.')
        ) || 0;

        const shortDesc = document.querySelector('.short-description .std')?.innerText.trim() || '';
        const fullDesc = document.querySelector('.tab-content .std')?.innerText.trim() || '';
        const combinedDescription = [shortDesc, fullDesc].filter(t => t).join('\n\n');

        let mainColor = 'Ãšnica';
        const tds = Array.from(document.querySelectorAll('#product-attribute-specs-table tr'));
        const colorRow = tds.find(tr => tr.innerText.includes('Cor'));
        if (colorRow) mainColor = colorRow.querySelector('.data')?.innerText.trim();

        let mainImages = Array.from(document.querySelectorAll('.MagicToolboxSelectorsContainer a'))
            .map(a => a.getAttribute('href')).filter(src => src);
        
        if (mainImages.length === 0) {
            const singleImg = document.querySelector('.MagicToolboxMainContainer a')?.getAttribute('href');
            if (singleImg) mainImages.push(singleImg);
        }
        mainImages = [...new Set(mainImages)];

        let sizes = [];
        try {
            const scripts = Array.from(document.querySelectorAll('script'));
            const configScript = scripts.find(s => s.innerText.includes('var spConfig'));
            if (configScript) {
                const match = configScript.innerText.match(/var spConfig = new Product.Config\((.*)\);/);
                if (match && match[1]) {
                    const json = JSON.parse(match[1]);
                    const sizeAttr = Object.values(json.attributes).find(a => a.label === 'Tamanho' || a.code === 'magework_tamanhos');
                    if (sizeAttr) sizes = sizeAttr.options.map(o => o.label);
                }
            }
        } catch (e) { }
        if (sizes.length === 0) sizes = ['Ãšnico'];

        const variantLinks = [];
        const relatedItems = document.querySelectorAll('#block-related .item');
        relatedItems.forEach(item => {
            const linkEl = item.querySelector('a.product-image');
            const nameEl = item.querySelector('.product-name a');
            if (linkEl && nameEl) {
                variantLinks.push({ url: linkEl.href, tempName: nameEl.innerText.trim() });
            }
        });

        let detectedCategory = '';
        const breadcrumbs = Array.from(document.querySelectorAll('.breadcrumbs li'));
        if (breadcrumbs.length > 0) {
            const validCrumbs = breadcrumbs.map(li => li.innerText.trim())
                .filter(t => !t.includes('InÃ­cio') && !t.includes('Home') && t !== '/');
            if (validCrumbs.length > 0) detectedCategory = validCrumbs[validCrumbs.length - 1]; 
        }

        return { title, rawPrice, description: combinedDescription, mainColor, mainImages, sizes, variantLinks, detectedCategory };
    });

    const finalPrice = parseFloat(((mainData.rawPrice * 1.30) + 15.00).toFixed(2));
    
    // --- LÃ“GICA DE CATEGORIA (Passando a URL) ---
    const targetCategoryId = getFixedCategoryId(mainData.detectedCategory, mainData.title, mainData.description, url);
    
    console.log(`   ğŸ“¦ ${mainData.title}`);
    console.log(`   ğŸ”— Link analisado para categoria.`);
    console.log(`   ğŸ“‚ ID Categoria Definido: ${targetCategoryId}`);

    const categoryRef = [{ _type: 'reference', _ref: targetCategoryId, _key: generateKey() }];

    console.log(`   â¬†ï¸ Uploading imagens...`);
    const mainImageAssets = [];
    for (const imgUrl of mainData.mainImages) {
        const asset = await uploadMediaToSanity(imgUrl);
        if (asset) mainImageAssets.push(asset);
    }

    const sanityVariants = [];
    if (mainImageAssets.length > 0) {
        sanityVariants.push({
            _key: generateKey(),
            _type: 'object',
            colorName: mainData.mainColor,
            variantImage: mainImageAssets[0],
            images: mainImageAssets,
            sizes: mainData.sizes.map(s => ({
                _key: generateKey(),
                size: s,
                price: finalPrice,
                stock: 10,
                sku: `${slugify(mainData.title).substring(0,10)}-${mainData.mainColor}-${s}`.toUpperCase()
            }))
        });
    }

    if (mainData.variantLinks.length > 0) {
        console.log(`   ğŸ”„ Visitando variantes...`);
        for (const variant of mainData.variantLinks) {
            try {
                await page.goto(variant.url, { waitUntil: 'domcontentloaded', timeout: 60000 });
                const variantPageData = await page.evaluate(() => {
                    let hdImage = document.querySelector('.MagicToolboxMainContainer a')?.getAttribute('href');
                    let specificColor = 'Variante';
                    const tds = Array.from(document.querySelectorAll('#product-attribute-specs-table tr'));
                    const colorRow = tds.find(tr => tr.innerText.includes('Cor'));
                    if (colorRow) specificColor = colorRow.querySelector('.data')?.innerText.trim();
                    return { hdImage, specificColor };
                });

                if (variantPageData.hdImage) {
                    const variantAsset = await uploadMediaToSanity(variantPageData.hdImage);
                    if (variantAsset) {
                        sanityVariants.push({
                            _key: generateKey(),
                            _type: 'object',
                            colorName: variantPageData.specificColor,
                            variantImage: variantAsset,
                            sizes: mainData.sizes.map(s => ({
                                _key: generateKey(),
                                size: s,
                                price: finalPrice,
                                stock: 5,
                                sku: `${slugify(mainData.title).substring(0,10)}-${variantPageData.specificColor}-${s}`.toUpperCase()
                            }))
                        });
                    }
                }
            } catch (err) { }
        }
    }

    const doc = {
        _type: 'product',
        title: mainData.title,
        slug: { _type: 'slug', current: slugify(mainData.title, { lower: true, strict: true }) + `-${Date.now().toString().slice(-4)}` },
        isActive: true,
        price: finalPrice,
        description: [{ _type: 'block', _key: generateKey(), style: 'normal', children: [{ _type: 'span', _key: generateKey(), text: mainData.description }] }],
        images: mainImageAssets,
        brand: 'SL',
        categories: categoryRef, 
        variants: sanityVariants,
        productType: 'fashion', 
        fashionSpecs: { gender: 'Fem', material: 'PadrÃ£o', model: 'PadrÃ£o' },
        logistics: { weight: 0.3, width: 20, height: 5, length: 20 }
    };

    try {
        const res = await client.create(doc);
        console.log(`   âœ… SUCESSO! Criado ID: ${res._id}`);
    } catch (err) { 
        console.error("   âŒ Erro Sanity:", err.message);
    }
}

async function startMassScraper() {
  console.log('ğŸš€ Iniciando Importador V11 (SeparaÃ§Ã£o Total de Conjuntos)...');
  let links = [];
  try {
      const fileContent = fs.readFileSync('links.txt', 'utf-8');
      links = fileContent.split('\n').map(l => l.trim()).filter(l => l.length > 0 && l.startsWith('http'));
      console.log(`ğŸ“‹ Lista carregada: ${links.length} produtos.`);
  } catch (e) {
      console.error('âŒ Erro: Arquivo links.txt nÃ£o encontrado.');
      return;
  }

  const browser = await puppeteer.connect({ browserURL: 'http://127.0.0.1:9222', defaultViewport: null });
  const page = (await browser.pages())[0];

  for (const [index, link] of links.entries()) {
      console.log(`\n========================================`);
      console.log(`PRODUTO ${index + 1} de ${links.length}`);
      console.log(`========================================`);
      try {
          await processSingleProduct(page, link);
      } catch (err) {
          console.error(`âŒ ERRO CRÃTICO no link:`, err.message);
      }
  }

  console.log('\nğŸ Finalizado!');
  process.exit(0);
}

startMassScraper();